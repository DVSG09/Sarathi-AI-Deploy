<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#2563eb">
    <title>MyPursu - Sarathi AI</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: "Inter", sans-serif;
        background: #f8fafc;
        height: 100vh;
        height: 100dvh; /* Dynamic viewport height for mobile */
        overflow: hidden;
        -webkit-overflow-scrolling: touch;
        touch-action: manipulation;
      }
      
      .app-container {
        display: flex;
        height: 100vh;
        height: 100dvh; /* Dynamic viewport height for mobile */
        position: relative;
      }
      
      /* Header */
      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: #f8fafc;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        z-index: 1000;
        border-bottom: 1px solid #e2e8f0;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      
      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .close-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        color: #64748b;
      }
      
      .close-btn:hover {
        background: #f1f5f9;
      }
      
      
      .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .offer-container {
        position: relative;
        display: inline-block;
      }

      .offer-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
      }

      .offer-btn {
        width: 40px;
        height: 40px;
        border: none;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        transition: all 0.3s ease;
        position: relative;
        z-index: 1001;
      }

      .offer-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(251, 191, 36, 0.4);
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      }

      .offer-btn:active {
        transform: scale(0.95);
      }

      .offer-tag {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        font-size: 10px;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        animation: pulse 2s infinite;
        position: relative;
        z-index: 1001;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .offer-popup {
        position: absolute;
        top: 50px;
        right: 0;
        background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
        color: #1e293b;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        width: 200px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 1002;
        border: 1px solid #e0f2fe;
      }

      .offer-popup.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .offer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(30, 41, 59, 0.1);
      }

      .offer-header h3 {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
      }

      .close-offer-btn {
        width: 20px;
        height: 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 16px;
        color: #64748b;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .close-offer-btn:hover {
        background: rgba(100, 116, 139, 0.1);
        color: #1e293b;
      }

      .offer-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding: 4px 0;
      }

      .offer-label {
        font-size: 12px;
        color: #475569;
        font-weight: 500;
        flex: 1;
      }

      .offer-rate {
        font-size: 13px;
        color: #1e293b;
        font-weight: 700;
        background: rgba(255, 255, 255, 0.9);
        padding: 3px 6px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-left: 8px;
        border: 1px solid #e2e8f0;
      }

      .offer-footer {
        text-align: center;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(30, 41, 59, 0.1);
      }

      .offer-footer small {
        color: #64748b;
        font-size: 10px;
        font-weight: 400;
      }
      
      .header-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        color: #64748b;
        transition: all 0.2s;
      }
      
      .header-btn:hover {
        background: #f1f5f9;
      }
      
      
      /* Sidebar */
      .sidebar {
        width: 280px;
        background: #f5f5f5;
        border-right: 1px solid #e0e0e0;
        padding: 0;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        height: 100dvh; /* Dynamic viewport height for mobile */
        z-index: 1000;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        -webkit-overflow-scrolling: touch;
      }
      
      /* Custom scrollbar for sidebar */
      .sidebar::-webkit-scrollbar {
        width: 6px;
      }
      
      .sidebar::-webkit-scrollbar-track {
        background: #f5f5f5;
      }
      
      .sidebar::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border-radius: 3px;
      }
      
      .sidebar::-webkit-scrollbar-thumb:hover {
        background: #a0a0a0;
      }
      
      .sidebar.collapsed {
        transform: translateX(-100%);
      }
      
      .sidebar-toggle {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1001;
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 8px;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
        color: #333333;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }
      
      .sidebar-toggle:hover {
        background: #e8e8e8;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      
      .sidebar-content {
        flex: 1;
        overflow-y: auto;
      }
      
      .sidebar-header {
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        position: sticky;
        top: 0;
        background: #f5f5f5;
        z-index: 10;
      }
      
      .sidebar-logo {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        color: white;
      }
      
      .sidebar-app-name {
        font-size: 18px;
        font-weight: 700;
        color: #333333;
      }
      
      .sidebar-section {
        padding: 15px 20px;
      }
      
      .collapsible-section {
        margin-bottom: 12px;
      }
      
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #ffffff;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #e0e0e0;
      }
      
      .section-header:hover {
        background: #f8f8f8;
      }
      
      .section-title {
        font-size: 14px;
        font-weight: 600;
        color: #333333;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .section-toggle {
        font-size: 12px;
        color: #666666;
        transition: transform 0.2s;
      }
      
      .section-toggle.collapsed {
        transform: rotate(-90deg);
      }
      
      .section-content {
        padding: 12px 16px;
        transition: all 0.3s ease;
        overflow: hidden;
      }
      
      .section-content.collapsed {
        max-height: 0;
        padding: 0 16px;
        opacity: 0;
      }
      
      .sidebar-title {
        font-size: 14px;
        font-weight: 600;
        color: #333333;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .new-chat-btn {
        width: 100%;
        background: #2563eb;
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 20px;
        transition: all 0.2s;
      }
      
      .new-chat-btn:hover {
        background: #1d4ed8;
      }
      
      .chat-history-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        margin-bottom: 4px;
        border-radius: 8px;
        cursor: pointer;
        color: #64748b;
        font-size: 14px;
        transition: all 0.2s;
        border: 1px solid transparent;
        position: relative;
      }
      
      .chat-history-item:hover {
        background: #f1f5f9;
        color: #1e293b;
      }
      
      .chat-history-item.active {
        background: #dbeafe;
        color: #2563eb;
        font-weight: 500;
        border-color: #93c5fd;
      }
      
      .chat-history-item .chat-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .chat-history-item .chat-time {
        font-size: 12px;
        color: #94a3b8;
        margin-left: 8px;
      }
      
      .chat-history-item .delete-btn {
        opacity: 0;
        width: 20px;
        height: 20px;
        border: none;
        background: none;
        color: #ef4444;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s;
      }
      
      .chat-history-item:hover .delete-btn {
        opacity: 1;
      }
      
      .delete-btn:hover {
        background: #fef2f2;
      }
      
      .nav-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        margin-bottom: 4px;
        border-radius: 8px;
        cursor: pointer;
        color: #64748b;
        font-size: 14px;
        transition: all 0.2s;
      }
      
      .nav-item:hover {
        background: #f1f5f9;
        color: #1e293b;
      }
      
      .nav-item.active {
        background: #dbeafe;
        color: #2563eb;
        font-weight: 500;
      }
      
      .live-support-btn {
        margin: 20px;
        background: #10b981;
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
      }
      
      .live-support-btn:hover {
        background: #059669;
      }
      
      .search-container {
        margin-bottom: 20px;
        position: relative;
      }
      
      .search-input {
        width: 100%;
        padding: 10px 12px 10px 36px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: #f8fafc;
        transition: all 0.2s;
      }
      
      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        font-size: 14px;
      }
      
      .library-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
      }
      
      .media-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 4px;
        border-radius: 6px;
        cursor: pointer;
        color: #64748b;
        font-size: 13px;
        transition: all 0.2s;
        position: relative;
      }
      
      .media-item:hover {
        background: #f1f5f9;
        color: #1e293b;
      }
      
      .media-icon {
        width: 16px;
        height: 16px;
        margin-right: 8px;
        color: #64748b;
      }
      
      .media-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .media-size {
        font-size: 11px;
        color: #94a3b8;
        margin-left: 8px;
      }
      
      .media-delete-btn {
        opacity: 0;
        width: 18px;
        height: 18px;
        border: none;
        background: none;
        color: #ef4444;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s;
        margin-left: 8px;
      }
      
      .media-item:hover .media-delete-btn {
        opacity: 1;
      }
      
      .media-delete-btn:hover {
        background: #fef2f2;
        color: #dc2626;
      }
      
      .file-input {
        display: none;
      }

      /* Exchange Rates Styles */
      .rates-container {
        padding: 8px 0;
      }

      .rate-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 6px;
        background: #ffffff;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
      }

      .rate-label {
        font-size: 12px;
        color: #666666;
        font-weight: 500;
        white-space: nowrap;
        flex: 1;
        min-width: 0;
      }

      .rate-value {
        font-size: 13px;
        color: #1e293b;
        font-weight: 600;
        background: #f0f0f0;
        padding: 2px 8px;
        border-radius: 4px;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .rate-update {
        text-align: center;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #e0e0e0;
      }

      .rate-update small {
        color: #666666;
        font-size: 11px;
      }
      
      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding-top: 60px;
        transition: all 0.3s ease;
        background: #f8fafc;
        min-height: 100vh;
        min-height: 100dvh; /* Dynamic viewport height for mobile */
        position: relative;
        width: 100%;
        margin-left: 0;
        overflow: hidden;
      }
      
       .main-content.sidebar-open {
         margin-left: 280px;
       }
       
       .chat-container {
         flex: 1;
         display: flex;
         flex-direction: column;
         background: #ffffff;
         margin: 8px;
         max-width: none;
         width: calc(100% - 16px);
         border-radius: 12px;
         box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
         overflow: hidden;
         border: 1px solid #e2e8f0;
         position: relative;
         -webkit-overflow-scrolling: touch;
       }
       
      .main-content.sidebar-open .chat-container {
        max-width: none;
        margin-left: 10px;
        width: calc(100% - 20px);
      }
      
      .chat-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.02) 0%, rgba(16, 185, 129, 0.02) 100%);
        pointer-events: none;
        z-index: 0;
      }
      
      .chat-container > * {
        position: relative;
        z-index: 1;
      }
      
      .chat-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e2e8f0;
        background: #ffffff;
      }
      
      .chat-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .messages-container {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        background: #f8fafc;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
      }
      
      .message {
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }
      
      .message.user {
        flex-direction: row-reverse;
      }
      
      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 500;
        flex-shrink: 0;
      }
      
      .message.bot .message-avatar {
        background: #dbeafe;
        color: #2563eb;
      }
      
      .message.user .message-avatar {
        background: #2563eb;
        color: white;
      }
      
      .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.5;
      }
      
      .message.bot .message-content {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        color: #1e293b;
      }
      
      .message.user .message-content {
        background: #2563eb;
        color: white;
      }
      
      
      .quick-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 16px;
        padding: 0 20px 20px 20px;
      }
      
      .quick-action {
        background: none;
        border: none;
        color: #64748b;
        font-size: 12px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
      }
      
      .quick-action:hover {
        background: #f1f5f9;
        color: #1e293b;
      }

      /* Welcome Screen Styles */
      .welcome-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        padding: 40px 20px;
        text-align: center;
        margin-top: -60px; /* Offset for header space */
        position: relative;
      }

      .welcome-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 16px;
        line-height: 1.2;
      }

      .welcome-header p {
        font-size: 1.1rem;
        color: #4a5568;
        margin-bottom: 40px;
        max-width: 600px;
        line-height: 1.5;
      }

      .welcome-input-container {
        width: 100%;
        max-width: 600px;
        margin-bottom: 30px;
      }

      .welcome-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        background: #f7fafc;
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 4px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .welcome-input-wrapper:focus-within {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .welcome-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 16px 20px;
        font-size: 1rem;
        color: #2d3748;
        outline: none;
        border-radius: 8px;
      }

      .welcome-input::placeholder {
        color: #a0aec0;
      }

      .welcome-send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        padding: 12px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 8px;
      }

      .welcome-send-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .welcome-send-btn:active {
        transform: translateY(0);
      }

      .welcome-quick-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 20px;
        justify-content: center;
      }
      
      .input-container {
        padding: 16px;
        border-top: 1px solid #e2e8f0;
        background: #ffffff;
        position: sticky;
        bottom: 0;
        z-index: 100;
      }
      
      .input-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 24px;
        padding: 12px 20px;
        min-height: 48px;
        margin: 0 8px;
      }

      .input-btn {
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s;
        flex-shrink: 0;
      }


      .toggle-container {
        position: relative;
        display: inline-block;
      }

      .toggle-btn {
        background: #6b7280;
        color: white;
        font-size: 16px;
        font-weight: bold;
      }

      .toggle-btn:hover {
        background: #4b5563;
      }

      .toggle-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        min-width: 180px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.2s ease;
        z-index: 1000;
        margin-bottom: 8px;
      }

      .toggle-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .toggle-dropdown .dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        cursor: pointer;
        font-size: 13px;
        color: #374151;
        transition: background 0.2s;
        border-bottom: 1px solid #f1f5f9;
      }

      .toggle-dropdown .dropdown-item:last-child {
        border-bottom: none;
      }

      .toggle-dropdown .dropdown-item:hover {
        background: #f8fafc;
        color: #1e293b;
      }

      .dropdown-icon {
        font-size: 14px;
        width: 16px;
        text-align: center;
      }
      
      .message-input {
        flex: 1;
        border: none;
        background: none;
        outline: none;
        font-size: 16px;
        color: #1e293b;
        padding: 8px 12px;
        min-width: 0;
        -webkit-appearance: none;
        border-radius: 0;
        width: 100%;
      }
      
      .message-input::placeholder {
        color: #94a3b8;
      }
      
      .send-btn {
        width: 32px;
        height: 32px;
        background: #2563eb;
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      
      .send-btn:hover {
        background: #1d4ed8;
      }
      
      .send-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
      }
      
      /* Mobile Responsive Styles */
      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          transform: translateX(-100%);
          z-index: 1001;
        }
        
        .sidebar:not(.collapsed) {
          transform: translateX(0);
        }
        
        .main-content {
          margin-left: 0 !important;
        }
        
        .main-content.sidebar-open {
          margin-left: 0 !important;
        }
        
        .chat-container {
          margin: 4px;
          width: calc(100% - 8px);
          border-radius: 8px;
        }
        
        .message-content {
          max-width: 85%;
          font-size: 14px;
          line-height: 1.4;
        }
        
        .input-container {
          padding: 12px;
        }
        
        .input-wrapper {
          padding: 8px 16px;
          gap: 8px;
          margin: 0 4px;
        }
        
        .message-input {
          font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .header {
          padding: 0 12px;
        }
        
        .sidebar-toggle {
          display: block;
          position: fixed;
          top: 20px;
          left: 20px;
          z-index: 1002;
        }
        
        .quick-actions {
          padding: 0 12px 12px 12px;
          gap: 6px;
        }
        
        .quick-action {
          font-size: 11px;
          padding: 6px 8px;
        }
        
        .welcome-container {
          padding: 20px 16px;
        }
        
        .welcome-header h1 {
          font-size: 2rem;
        }
        
        .welcome-header p {
          font-size: 1rem;
        }
        
        .welcome-input-container {
          margin-bottom: 20px;
        }
        
        .welcome-input-wrapper {
          padding: 2px;
        }
        
        .welcome-input {
          padding: 12px 16px;
          font-size: 16px; /* Prevents zoom on iOS */
        }
      }
      
      @media (max-width: 480px) {
        .chat-container {
          margin: 2px;
          width: calc(100% - 4px);
          border-radius: 6px;
        }
        
        .messages-container {
          padding: 12px;
        }
        
        .message {
          margin-bottom: 12px;
        }
        
        .message-content {
          max-width: 90%;
          padding: 10px 12px;
          font-size: 14px;
        }
        
        .input-container {
          padding: 8px;
        }
        
        .input-wrapper {
          padding: 6px 12px;
          gap: 6px;
          margin: 0 2px;
        }
        
        .send-btn {
          width: 28px;
          height: 28px;
        }
        
        .header {
          height: 56px;
          padding: 0 8px;
        }
        
        .main-content {
          padding-top: 56px;
        }
        
        .welcome-header h1 {
          font-size: 1.8rem;
        }
        
        .welcome-header p {
          font-size: 0.9rem;
        }
      }
      
      /* Touch-friendly improvements */
      @media (hover: none) and (pointer: coarse) {
        .chat-history-item,
        .nav-item,
        .media-item {
          min-height: 44px; /* iOS touch target size */
        }
        
        .send-btn,
        .input-btn,
        .header-btn {
          min-width: 44px;
          min-height: 44px;
        }
        
        .quick-action {
          min-height: 36px;
          padding: 8px 12px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <button class="close-btn">‚úï</button>
      </div>
      <div class="header-right">
        <div class="offer-container">
          <div class="offer-wrapper">
            <button class="offer-btn" id="offer-btn" title="Special Offers">
              üéÅ
            </button>
            <span class="offer-tag">OFFER</span>
          </div>
          <div class="offer-popup" id="offer-popup">
            <div class="offer-header">
              <h3>üéâ Special Exchange Rate Offers!</h3>
              <button class="close-offer-btn" id="close-offer-btn">√ó</button>
            </div>
            <div class="offer-content">
              <div class="offer-item">
                <div class="offer-label">New Users (First $100):</div>
                <div class="offer-rate" id="popup-rate-new">‚Çπ103.29</div>
              </div>
              <div class="offer-item">
                <div class="offer-label">Existing Users:</div>
                <div class="offer-rate" id="popup-rate-existing">‚Çπ88.41</div>
              </div>
              <div class="offer-item">
                <div class="offer-label">Concierge Package:</div>
                <div class="offer-rate" id="popup-rate-concierge">‚Çπ90.00</div>
              </div>
              <div class="offer-footer">
                <small id="popup-timestamp">Updated: Just now</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="app-container">
      <!-- Sidebar Toggle -->
      <button class="sidebar-toggle" id="sidebar-toggle">
        ‚ò∞
      </button>
      
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">S</div>
          <div class="sidebar-app-name">Sarathi</div>
        </div>
        <div class="sidebar-content">
          <div class="sidebar-section">
            <button class="new-chat-btn" id="new-chat-btn">
              ‚ûï New Chat
            </button>
            
            <div class="search-container">
              <span class="search-icon">üîç</span>
              <input type="text" class="search-input" id="search-input" placeholder="Search chats...">
            </div>
            
            <!-- Chat History Section -->
            <div class="collapsible-section">
              <div class="section-header" id="chat-history-header">
                <div class="section-title">
                  üí¨ Chat History
                </div>
                <span class="section-toggle" id="chat-history-toggle">‚ñº</span>
              </div>
              <div class="section-content" id="chat-history-content">
                <div id="chat-history-list">
                  <!-- Chat history items will be dynamically added here -->
                </div>
              </div>
            </div>
            
            <!-- Library Section -->
            <div class="collapsible-section">
              <div class="section-header" id="library-header">
                <div class="section-title">
                  üìö Library
                </div>
                <span class="section-toggle" id="library-toggle">‚ñº</span>
              </div>
              <div class="section-content" id="library-content">
                <div id="media-library">
                  <!-- Media files will be dynamically added here -->
                </div>
              </div>
            </div>
            
            <!-- Exchange Rates Section -->
            <div class="collapsible-section">
              <div class="section-header" id="rates-header">
                <div class="section-title">
                  üí± Exchange Rates
                </div>
                <span class="section-toggle" id="rates-toggle">‚ñº</span>
              </div>
              <div class="section-content" id="rates-content">
                <div class="rates-container">
                  <div class="rate-item">
                    <div class="rate-label">New Users (First $100)</div>
                    <div class="rate-value">$1 = ‚Çπ103.29</div>
                  </div>
                  <div class="rate-item">
                    <div class="rate-label">Existing Users</div>
                    <div class="rate-value">$1 = ‚Çπ88.41</div>
                  </div>
                  <div class="rate-item">
                    <div class="rate-label">Concierge Package</div>
                    <div class="rate-value">$1 = ‚Çπ90.00</div>
                  </div>
                  <div class="rate-update">
                    <small>Last updated: <span id="rate-timestamp">Just now</span></small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Support Section -->
            <div class="collapsible-section">
              <div class="section-header" id="support-header">
                <div class="section-title">
                  üéß Support
                </div>
                <span class="section-toggle" id="support-toggle">‚ñº</span>
              </div>
              <div class="section-content" id="support-content">
                <button class="live-support-btn">
                  üéß Live Support
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="chat-container">
          <div class="chat-header">
            <div class="chat-title">
              üí¨ Sarathi AI Chatbot
            </div>
          </div>
          
          <div class="messages-container" id="messages">
            <!-- Messages will be dynamically added here -->
          </div>
          
          <div class="input-container">
            <div class="input-wrapper">
              <div class="toggle-container">
                <button class="input-btn toggle-btn" title="More Options" id="toggle-btn">+</button>
                <div class="toggle-dropdown" id="toggle-dropdown">
                  <div class="dropdown-item" id="upload-option">
                    <span class="dropdown-icon">üìÅ</span>
                    <span>New Files & Folders</span>
                  </div>
                  <div class="dropdown-item" id="download-option">
                    <span class="dropdown-icon">‚¨á</span>
                    <span>Download Chat</span>
                  </div>
                </div>
              </div>
              <input 
                type="text" 
                id="user-input" 
                class="message-input" 
                placeholder="Message Sarathi..."
              />
              <button id="send-button" class="send-btn">
                ‚û§
              </button>
            </div>
          </div>
          
          <div class="quick-actions">
            <button class="quick-action">What is Remit2Any?</button>
            <button class="quick-action">How to pay via UPI</button>
            <button class="quick-action">Show concierge packages</button>
            <button class="quick-action">Track my transfer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden file input for uploads -->
    <input type="file" id="file-input" class="file-input" multiple accept="image/*,application/pdf,.doc,.docx,.txt">

    <script>
      const messagesDiv = document.getElementById("messages");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const newChatBtn = document.getElementById("new-chat-btn");
      const chatHistoryList = document.getElementById("chat-history-list");
      const searchInput = document.getElementById("search-input");
      const mediaLibrary = document.getElementById("media-library");
      const fileInput = document.getElementById("file-input");
      const toggleBtn = document.getElementById("toggle-btn");
      const toggleDropdown = document.getElementById("toggle-dropdown");
      const uploadOption = document.getElementById("upload-option");
      const downloadOption = document.getElementById("download-option");
      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebar-toggle");
      const mainContent = document.querySelector(".main-content");
      const offerBtn = document.getElementById("offer-btn");
      const offerPopup = document.getElementById("offer-popup");
      const closeOfferBtn = document.getElementById("close-offer-btn");

      // Chat history management
      let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      let mediaFiles = JSON.parse(localStorage.getItem('mediaFiles') || '[]');
      let currentChatId = null;
      let currentChatMessages = [];
      let filteredChatHistory = [];
      let sidebarCollapsed = true; // Default to collapsed
      let currentSessionId = null; // Session management

      window.onload = () => {
        loadChatHistory();
        loadMediaLibrary();
        // Check if there's an existing session, if not create new one
        initializeSession();
        setupEventListeners();
        initializeSidebarState();
        updateExchangeRates();
        setupMobileOptimizations();
      };

      // Show normal chat interface (not welcome screen)
      function showNormalChatInterface() {
        const chatHeader = document.querySelector('.chat-header');
        const inputContainer = document.querySelector('.input-container');
        const quickActions = document.querySelector('.quick-actions');
        const welcomeContainer = document.querySelector('.welcome-container');
        
        // Show normal chat elements
        if (chatHeader) chatHeader.style.display = 'block';
        if (inputContainer) inputContainer.style.display = 'flex';
        if (quickActions) quickActions.style.display = 'flex';
        
        // Hide welcome screen if it exists
        if (welcomeContainer) welcomeContainer.style.display = 'none';
      }

      // Session Management Functions
      async function initializeSession() {
        try {
          // Check if this is a new tab/window or a refresh
          const isNewTab = !sessionStorage.getItem('tabInitialized');
          
          if (isNewTab) {
            // This is a new tab/window - start fresh
            sessionStorage.setItem('tabInitialized', 'true');
            await createNewSession();
          } else {
            // This is a refresh - restore current session
            currentSessionId = localStorage.getItem('currentSessionId');
            
            if (!currentSessionId) {
              // No existing session, create new one
              const response = await fetch('/session/new');
              const data = await response.json();
              currentSessionId = data.session_id;
              localStorage.setItem('currentSessionId', currentSessionId);
            }
            
            // Load conversation history for this session
            await loadSessionHistory();
            
            // Show normal chat interface instead of welcome screen
            showNormalChatInterface();
          }
        } catch (error) {
          console.error('Error initializing session:', error);
          // Fallback: create a local session ID
          currentSessionId = 'local_' + Date.now();
          showNormalChatInterface();
        }
      }

      async function loadSessionHistory() {
        if (!currentSessionId) return;
        
        try {
          const response = await fetch(`/session/${currentSessionId}/history`);
          const data = await response.json();
          
          if (data.history && data.history.length > 0) {
            // Clear current messages and load session history
            messagesDiv.innerHTML = '';
            currentChatMessages = [];
            
            data.history.forEach(msg => {
              const sender = msg.role === 'user' ? 'user' : 'bot';
              appendMessage(msg.message, sender, true); // true = save to current chat
            });
          }
        } catch (error) {
          console.error('Error loading session history:', error);
        }
      }

      async function createNewSession() {
        try {
          const response = await fetch('/session/new');
          const data = await response.json();
          currentSessionId = data.session_id;
          localStorage.setItem('currentSessionId', currentSessionId);
          
          // Clear current conversation
          messagesDiv.innerHTML = '';
          currentChatMessages = [];
          
          // Show welcome screen with clean layout
          showWelcomeScreen();
          
          return currentSessionId;
        } catch (error) {
          console.error('Error creating new session:', error);
          return null;
        }
      }

      function showWelcomeScreen() {
        // Clear messages and show welcome content
        messagesDiv.innerHTML = '';
        
        // Hide the chat header
        const chatHeader = document.querySelector('.chat-header');
        if (chatHeader) {
          chatHeader.style.display = 'none';
        }
        
        // Create welcome container
        const welcomeContainer = document.createElement('div');
        welcomeContainer.className = 'welcome-container';
        welcomeContainer.innerHTML = `
          <div class="welcome-header">
            <h1>Sarathi AI</h1>
            <p>Your smart companion on the MyPursu journey.</p>
          </div>
          <div class="welcome-input-container">
            <div class="welcome-input-wrapper">
              <input type="text" id="welcome-input" placeholder="Ask your question here" class="welcome-input">
              <button id="welcome-send-btn" class="welcome-send-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22,2 15,22 11,13 2,9"></polygon>
                </svg>
              </button>
            </div>
          </div>
          <div class="welcome-quick-actions">
            <button class="quick-action">What is Remit2Any?</button>
            <button class="quick-action">How to pay via UPI</button>
            <button class="quick-action">Show concierge packages</button>
            <button class="quick-action">Track my transfer</button>
          </div>
        `;
        
        messagesDiv.appendChild(welcomeContainer);
        
        // Expand the screen by collapsing the sidebar
        sidebarCollapsed = true;
        sidebar.classList.add('collapsed');
        mainContent.classList.remove('sidebar-open');
        sidebarToggle.textContent = '‚ò∞';
        sidebarToggle.style.left = '20px';
        
        // Hide the normal chat input container
        const inputContainer = document.querySelector('.input-container');
        if (inputContainer) {
          inputContainer.style.display = 'none';
        }
        
        // Hide the original quick action buttons at the bottom
        const quickActions = document.querySelector('.quick-actions');
        if (quickActions) {
          quickActions.style.display = 'none';
        }
        
        // Add event listeners for welcome screen
        setupWelcomeScreenEvents();
      }

      function setupWelcomeScreenEvents() {
        const welcomeInput = document.getElementById('welcome-input');
        const welcomeSendBtn = document.getElementById('welcome-send-btn');
        
        if (welcomeInput && welcomeSendBtn) {
          // Send button click
          welcomeSendBtn.onclick = () => {
            const message = welcomeInput.value.trim();
            if (message.length > 0) {
              transitionToNormalChat(message);
            }
          };
          
          // Enter key press
          welcomeInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              const message = welcomeInput.value.trim();
              if (message.length > 0) {
                transitionToNormalChat(message);
              }
            }
          });
        }
        
        // Re-attach quick action button events for welcome screen
        const quickActionButtons = document.querySelectorAll('.welcome-quick-actions .quick-action');
        quickActionButtons.forEach(button => {
          button.addEventListener('click', function() {
            const question = button.textContent.trim();
            transitionToNormalChat(question);
          });
        });
      }

      function transitionToNormalChat(message) {
        // Clear welcome screen
        messagesDiv.innerHTML = '';
        
        // Show the chat header again
        const chatHeader = document.querySelector('.chat-header');
        if (chatHeader) {
          chatHeader.style.display = 'block';
        }
        
        // Show normal chat input container
        const inputContainer = document.querySelector('.input-container');
        if (inputContainer) {
          inputContainer.style.display = 'flex';
        }
        
        // Show quick actions section again
        const quickActions = document.querySelector('.quick-actions');
        if (quickActions) {
          quickActions.style.display = 'flex';
        }
        
        // Add the user message
        appendMessage(message, "user");
        
        // Show typing indicator and get response
        const typingMsg = document.createElement("div");
        typingMsg.className = "message bot";
        typingMsg.innerHTML = `
          <div class="message-avatar">S</div>
          <div class="message-content">ü§ñ Sarathi is typing...</div>
        `;
        messagesDiv.appendChild(typingMsg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Send message to backend
        fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            message: message,
            session_id: currentSessionId 
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            // Remove typing indicator
            typingMsg.remove();
            
            // Add bot response
            appendMessage(data.response, "bot");
            
            // Update session ID if provided
            if (data.session_id) {
              currentSessionId = data.session_id;
              localStorage.setItem('currentSessionId', currentSessionId);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            typingMsg.remove();
            appendMessage("Sorry, I'm having trouble right now. Please try again.", "bot");
          });
      }

      function initializeSidebarState() {
        // Set initial sidebar state
        sidebar.classList.toggle('collapsed', sidebarCollapsed);
        mainContent.classList.toggle('sidebar-open', !sidebarCollapsed);
        sidebarToggle.textContent = sidebarCollapsed ? '‚ò∞' : '‚úï';
        sidebarToggle.style.left = sidebarCollapsed ? '20px' : '300px';
      }

      function setupMobileOptimizations() {
        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
          const now = (new Date()).getTime();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        }, false);

        // Prevent pull-to-refresh on mobile
        document.addEventListener('touchmove', function(e) {
          if (e.touches.length > 1) {
            e.preventDefault();
          }
        }, { passive: false });

        // Handle viewport changes for mobile keyboards
        const viewport = document.querySelector('meta[name=viewport]');
        let initialViewport = viewport.getAttribute('content');
        
        window.addEventListener('resize', function() {
          if (window.innerHeight < 500) {
            // Keyboard is likely open
            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
          } else {
            // Keyboard is likely closed
            viewport.setAttribute('content', initialViewport);
          }
        });

        // Auto-focus input on mobile when keyboard opens
        const messageInput = document.getElementById('user-input');
        if (messageInput) {
          messageInput.addEventListener('focus', function() {
            setTimeout(() => {
              this.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
          });
        }

        // Improve touch scrolling
        const messagesContainer = document.getElementById('messages');
        if (messagesContainer) {
          messagesContainer.style.webkitOverflowScrolling = 'touch';
        }

        // Save current state before page unload
        window.addEventListener('beforeunload', () => {
          saveChat();
        });

        // Clean up sessionStorage when tab is closed
        window.addEventListener('beforeunload', () => {
          // Don't remove sessionStorage immediately, let it persist for a moment
          // This helps distinguish between refresh and new tab
        });

        // Save current state periodically
        setInterval(() => {
          if (currentChatMessages.length > 0) {
            saveChat();
          }
        }, 30000); // Save every 30 seconds

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible') {
            // Page became visible - check if we need to restore session
            const tabInitialized = sessionStorage.getItem('tabInitialized');
            if (!tabInitialized) {
              // This might be a new tab, start fresh
              sessionStorage.setItem('tabInitialized', 'true');
            }
          }
        });
      }

      function setupEventListeners() {

        // Search functionality
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          if (query.trim() === '') {
            filteredChatHistory = [...chatHistory];
          } else {
            filteredChatHistory = chatHistory.filter(chat => 
              chat.title.toLowerCase().includes(query) ||
              chat.messages.some(msg => msg.text.toLowerCase().includes(query))
            );
          }
          loadChatHistory();
        });

        // Toggle dropdown functionality
        toggleBtn.onclick = (e) => {
          e.stopPropagation();
          toggleDropdown.classList.toggle('show');
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!toggleBtn.contains(e.target) && !toggleDropdown.contains(e.target)) {
            toggleDropdown.classList.remove('show');
          }
        });

        // Upload functionality
        uploadOption.onclick = () => {
          fileInput.click();
          toggleDropdown.classList.remove('show');
        };

        fileInput.addEventListener('change', (e) => {
          const files = Array.from(e.target.files);
          files.forEach(file => {
            const mediaItem = {
              id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
              name: file.name,
              size: file.size,
              type: file.type,
              chatId: currentChatId,
              timestamp: Date.now(),
              file: file
            };
            mediaFiles.unshift(mediaItem);
            
            // Add message about uploaded file
            appendMessage(`üìé Uploaded: ${file.name}`, 'user');
            appendMessage(`File "${file.name}" has been uploaded successfully! I can help you with questions about this file.`, 'bot');
          });
          
          localStorage.setItem('mediaFiles', JSON.stringify(mediaFiles));
          loadMediaLibrary();
          e.target.value = ''; // Reset file input
        });

        // Download functionality
        downloadOption.onclick = () => {
          downloadChatHistory();
          toggleDropdown.classList.remove('show');
        };

        // Sidebar toggle functionality
        sidebarToggle.onclick = () => {
          sidebarCollapsed = !sidebarCollapsed;
          sidebar.classList.toggle('collapsed', sidebarCollapsed);
          mainContent.classList.toggle('sidebar-open', !sidebarCollapsed);
          sidebarToggle.textContent = sidebarCollapsed ? '‚ò∞' : '‚úï';
          
          // Adjust sidebar toggle position
          if (sidebarCollapsed) {
            sidebarToggle.style.left = '20px';
          } else {
            sidebarToggle.style.left = '300px';
          }
        };

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 768 && !sidebarCollapsed) {
            if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
              sidebarCollapsed = true;
              sidebar.classList.add('collapsed');
              mainContent.classList.remove('sidebar-open');
              sidebarToggle.textContent = '‚ò∞';
              sidebarToggle.style.left = '20px';
            }
          }
        });

        // Collapsible sections functionality
        setupCollapsibleSections();

        // Offer button functionality
        offerBtn.onclick = (e) => {
          e.stopPropagation();
          offerPopup.classList.toggle('show');
        };

        closeOfferBtn.onclick = (e) => {
          e.stopPropagation();
          offerPopup.classList.remove('show');
        };

        // Close offer popup when clicking outside
        document.addEventListener('click', (e) => {
          if (!offerBtn.contains(e.target) && !offerPopup.contains(e.target)) {
            offerPopup.classList.remove('show');
          }
        });
      }

      function setupCollapsibleSections() {
        const sections = [
          { header: 'chat-history-header', content: 'chat-history-content', toggle: 'chat-history-toggle' },
          { header: 'library-header', content: 'library-content', toggle: 'library-toggle' },
          { header: 'rates-header', content: 'rates-content', toggle: 'rates-toggle' },
          { header: 'support-header', content: 'support-content', toggle: 'support-toggle' }
        ];

        sections.forEach(section => {
          const header = document.getElementById(section.header);
          const content = document.getElementById(section.content);
          const toggle = document.getElementById(section.toggle);
          let isCollapsed = false;

          header.onclick = () => {
            isCollapsed = !isCollapsed;
            content.classList.toggle('collapsed', isCollapsed);
            toggle.classList.toggle('collapsed', isCollapsed);
          };
        });
      }

      function loadMediaLibrary() {
        mediaLibrary.innerHTML = '';
        
        if (mediaFiles.length === 0) {
          mediaLibrary.innerHTML = '<div style="color: #94a3b8; font-size: 12px; padding: 8px 12px;">No media files yet</div>';
          return;
        }

        mediaFiles.slice(0, 10).forEach(file => {
          const mediaItem = document.createElement("div");
          mediaItem.className = "media-item";
          
          const icon = document.createElement("span");
          icon.className = "media-icon";
          icon.textContent = getFileIcon(file.type);
          
          const name = document.createElement("span");
          name.className = "media-name";
          name.textContent = file.name;
          
          const size = document.createElement("span");
          size.className = "media-size";
          size.textContent = formatFileSize(file.size);
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "media-delete-btn";
          deleteBtn.innerHTML = "√ó";
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteMediaFile(file.id);
          };
          
          mediaItem.appendChild(icon);
          mediaItem.appendChild(name);
          mediaItem.appendChild(size);
          mediaItem.appendChild(deleteBtn);
          
          mediaItem.onclick = () => {
            // Find and load the chat that contains this file
            const chat = chatHistory.find(c => c.id === file.chatId);
            if (chat) {
              loadChat(chat.id);
            }
          };
          
          mediaLibrary.appendChild(mediaItem);
        });
      }

      function getFileIcon(type) {
        if (type.startsWith('image/')) return 'üñºÔ∏è';
        if (type === 'application/pdf') return 'üìÑ';
        if (type.includes('document') || type.includes('text')) return 'üìù';
        return 'üìé';
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }

      function deleteMediaFile(fileId) {
        if (confirm('Are you sure you want to delete this file?')) {
          // Remove file from mediaFiles array
          mediaFiles = mediaFiles.filter(file => file.id !== fileId);
          
          // Save updated mediaFiles to localStorage
          localStorage.setItem('mediaFiles', JSON.stringify(mediaFiles));
          
          // Reload the media library
          loadMediaLibrary();
          
          // Show confirmation message
          appendMessage(`üóëÔ∏è File deleted successfully`, 'bot');
        }
      }

      function downloadChatHistory() {
        if (currentChatMessages.length === 0) {
          alert('No chat history to download');
          return;
        }

        const chatData = {
          title: `Chat_${new Date().toISOString().split('T')[0]}`,
          timestamp: new Date().toISOString(),
          messages: currentChatMessages
        };

        // Create text content
        let textContent = `MyPursu Chat History - ${chatData.title}\n`;
        textContent += `Generated: ${new Date().toLocaleString()}\n\n`;
        textContent += '='.repeat(50) + '\n\n';

        chatData.messages.forEach(msg => {
          const sender = msg.sender === 'user' ? 'You' : 'Sarathi AI';
          const time = new Date(msg.timestamp).toLocaleTimeString();
          textContent += `[${time}] ${sender}: ${msg.text}\n\n`;
        });

        // Create and download file
        const blob = new Blob([textContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${chatData.title}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function startNewChat() {
        currentChatId = Date.now().toString();
        currentChatMessages = [];
        messagesDiv.innerHTML = '';
        
        // Show welcome screen with clean layout
        showWelcomeScreen();
      }

      function loadChatHistory() {
        chatHistoryList.innerHTML = '';
        
        const chatsToShow = filteredChatHistory.length > 0 ? filteredChatHistory : chatHistory;
        
        chatsToShow.forEach(chat => {
          const chatItem = document.createElement("div");
          chatItem.className = "chat-history-item";
          chatItem.dataset.chatId = chat.id;
          
          const title = document.createElement("div");
          title.className = "chat-title";
          title.textContent = chat.title;
          
          const time = document.createElement("div");
          time.className = "chat-time";
          time.textContent = formatTime(chat.timestamp);
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.innerHTML = "√ó";
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteChat(chat.id);
          };
          
          chatItem.appendChild(title);
          chatItem.appendChild(time);
          chatItem.appendChild(deleteBtn);
          
          chatItem.onclick = () => loadChat(chat.id);
          
          chatHistoryList.appendChild(chatItem);
        });
      }

      async function loadChat(chatId) {
        const chat = chatHistory.find(c => c.id === chatId);
        if (!chat) return;
        
        currentChatId = chatId;
        currentChatMessages = chat.messages;
        
        // Set the session ID from the chat
        if (chat.sessionId) {
          currentSessionId = chat.sessionId;
          localStorage.setItem('currentSessionId', currentSessionId);
        }
        
        // Clear current messages
        messagesDiv.innerHTML = '';
        
        // Load chat messages
        chat.messages.forEach(msg => {
          appendMessage(msg.text, msg.sender, false); // false = don't save to current chat
        });
        
        // Update active state
        document.querySelectorAll('.chat-history-item').forEach(item => {
          item.classList.remove('active');
        });
        document.querySelector(`[data-chat-id="${chatId}"]`).classList.add('active');
        
        // Show normal chat interface (not welcome screen)
        const chatHeader = document.querySelector('.chat-header');
        if (chatHeader) {
          chatHeader.style.display = 'block';
        }
        
        const inputContainer = document.querySelector('.input-container');
        if (inputContainer) {
          inputContainer.style.display = 'flex';
        }
        
        const quickActions = document.querySelector('.quick-actions');
        if (quickActions) {
          quickActions.style.display = 'flex';
        }
      }

      function saveChat() {
        if (currentChatMessages.length === 0) return;
        
        // Generate chat ID if not exists
        if (!currentChatId) {
          currentChatId = Date.now().toString();
        }
        
        const firstUserMessage = currentChatMessages.find(msg => msg.sender === 'user');
        const title = firstUserMessage ? 
          (firstUserMessage.text.length > 30 ? 
            firstUserMessage.text.substring(0, 30) + '...' : 
            firstUserMessage.text) : 
          'New Chat';
        
        const chatData = {
          id: currentChatId,
          title: title,
          timestamp: Date.now(),
          messages: [...currentChatMessages], // Create a copy
          sessionId: currentSessionId
        };
        
        // Remove existing chat with same ID
        chatHistory = chatHistory.filter(c => c.id !== currentChatId);
        
        // Add new chat at the beginning
        chatHistory.unshift(chatData);
        
        // Keep only last 20 chats
        chatHistory = chatHistory.slice(0, 20);
        
        // Save to localStorage
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        
        // Update filtered list if search is active
        if (searchInput.value.trim() !== '') {
          const query = searchInput.value.toLowerCase();
          filteredChatHistory = chatHistory.filter(chat => 
            chat.title.toLowerCase().includes(query) ||
            chat.messages.some(msg => msg.text.toLowerCase().includes(query))
          );
        } else {
          filteredChatHistory = [];
        }
        
        // Reload chat history
        loadChatHistory();
      }

      function deleteChat(chatId) {
        chatHistory = chatHistory.filter(c => c.id !== chatId);
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        loadChatHistory();
        
        // If deleted chat was active, start new chat
        if (currentChatId === chatId) {
          startNewChat();
        }
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
        return date.toLocaleDateString();
      }

      async function updateExchangeRates() {
        try {
          const response = await fetch('/api/rates');
          const rates = await response.json();
          
          // Update the rate values in the sidebar
          const rateItems = document.querySelectorAll('.rate-item');
          if (rateItems.length >= 3) {
            rateItems[0].querySelector('.rate-value').textContent = `$1 = ‚Çπ${rates.new_user_rate}`;
            rateItems[1].querySelector('.rate-value').textContent = `$1 = ‚Çπ${rates.regular_rate}`;
            rateItems[2].querySelector('.rate-value').textContent = `$1 = ‚Çπ${rates.concierge_rate}`;
          }
          
          // Update popup exchange rates
          const popupRateNew = document.getElementById('popup-rate-new');
          const popupRateExisting = document.getElementById('popup-rate-existing');
          const popupRateConcierge = document.getElementById('popup-rate-concierge');
          
          if (popupRateNew) {
            popupRateNew.textContent = `‚Çπ${rates.new_user_rate}`;
          }
          if (popupRateExisting) {
            popupRateExisting.textContent = `‚Çπ${rates.regular_rate}`;
          }
          if (popupRateConcierge) {
            popupRateConcierge.textContent = `‚Çπ${rates.concierge_rate}`;
          }
          
          // Update timestamps
          const timestampElement = document.getElementById('rate-timestamp');
          const popupTimestamp = document.getElementById('popup-timestamp');
          const updateTime = new Date(rates.last_updated).toLocaleTimeString();
          
          if (timestampElement) {
            timestampElement.textContent = updateTime;
          }
          if (popupTimestamp) {
            popupTimestamp.textContent = `Updated: ${updateTime}`;
          }
        } catch (error) {
          console.error('Error fetching exchange rates:', error);
          // Keep existing rates if API fails
        }
      }

      // Auto-refresh rates every 30 minutes to check for daily updates
      setInterval(updateExchangeRates, 1800000);

      // New chat button
      newChatBtn.onclick = async () => {
        if (currentChatMessages.length > 0) {
          saveChat();
        }
        await createNewSession();
      };

      function appendMessage(text, sender, saveToChat = true) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;
        
        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = sender === "bot" ? "S" : "U";
        
        const content = document.createElement("div");
        content.className = "message-content";
        content.innerHTML = text.replace(/\n/g, '<br>');
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(content);
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Save message to current chat (only if saveToChat is true)
        if (saveToChat) {
          currentChatMessages.push({
            text: text,
            sender: sender,
            timestamp: Date.now()
          });
          
          // Auto-save chat after every message
          setTimeout(() => saveChat(), 500);
        }
      }



      // Send user message
      sendButton.onclick = async () => {
        const message = userInput.value.trim();
        if (!message) return;
        appendMessage(message, "user");
        userInput.value = "";

        const typingMsg = document.createElement("div");
        typingMsg.className = "message bot";
        typingMsg.innerHTML = `
          <div class="message-avatar">S</div>
          <div class="message-content">ü§ñ Sarathi is typing...</div>
        `;
        messagesDiv.appendChild(typingMsg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              message: message,
              session_id: currentSessionId 
            }),
          });
          messagesDiv.removeChild(typingMsg);
          if (response.ok) {
            const data = await response.json();
            appendMessage(data.response || "No response from server", "bot");
            
            // Update session ID if returned
            if (data.session_id) {
              currentSessionId = data.session_id;
              localStorage.setItem('currentSessionId', currentSessionId);
            }
          } else appendMessage("Error: Failed to get response", "bot");
        } catch {
          messagesDiv.removeChild(typingMsg);
          appendMessage("Error: Could not connect to server", "bot");
        }
      };

      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) sendButton.click();
      });

      // Quick action buttons
      document.querySelectorAll(".quick-action").forEach((btn) => {
        btn.addEventListener("click", () => {
          const question = btn.textContent;
          appendMessage(question, "user");
          userInput.value = "";
          
          const typingMsg = document.createElement("div");
          typingMsg.className = "message bot";
          typingMsg.innerHTML = `
            <div class="message-avatar">S</div>
            <div class="message-content">ü§ñ Sarathi is typing...</div>
          `;
          messagesDiv.appendChild(typingMsg);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;

          fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              message: question,
              session_id: currentSessionId 
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              messagesDiv.removeChild(typingMsg);
              appendMessage(data.response || "No response from server", "bot");
              
              // Update session ID if returned
              if (data.session_id) {
                currentSessionId = data.session_id;
                localStorage.setItem('currentSessionId', currentSessionId);
              }
            })
            .catch(() => {
              messagesDiv.removeChild(typingMsg);
              appendMessage("Error: Could not connect to server", "bot");
            });
        });
      });

      // Live support button
      document.querySelector(".live-support-btn").onclick = () => {
        appendMessage("I need live support", "user");
        
        const typingMsg = document.createElement("div");
        typingMsg.className = "message bot";
        typingMsg.innerHTML = `
          <div class="message-avatar">S</div>
          <div class="message-content">ü§ñ Sarathi is typing...</div>
        `;
        messagesDiv.appendChild(typingMsg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            message: "I need live support",
            session_id: currentSessionId 
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            messagesDiv.removeChild(typingMsg);
            appendMessage(data.response || "No response from server", "bot");
            
            // Update session ID if returned
            if (data.session_id) {
              currentSessionId = data.session_id;
              localStorage.setItem('currentSessionId', currentSessionId);
            }
          })
          .catch(() => {
            messagesDiv.removeChild(typingMsg);
            appendMessage("Error: Could not connect to server", "bot");
          });
      };

      // Header buttons functionality
      document.querySelector(".close-btn").onclick = () => {
        if (confirm("Are you sure you want to close?")) {
          window.close();
        }
      };

      // Header button functionality (only for More button now)
      document.querySelector(".header-btn").onclick = () => {
        appendMessage("More options clicked", "user");
      };

      document.querySelector(".stop-btn").onclick = () => {
        appendMessage("Stop button clicked", "user");
      };
    </script>
  </body>
</html>
